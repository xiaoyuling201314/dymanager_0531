require(["../config.min","../base.min"],function(){require(["common/lightbox.min"],function(e){e.run(".gallery")}),require(["common/pagination.min"],function(){$("#pagination").pagination({pageCount:pageCount,current:curPage,callback:function(n){var t=n.getCurrent();$("#listForm input[name='curPage']").val(t),$("#listForm").submit()}})}),
	
	  require(["common/pagination.min"],
			   function(){$("#paginationSelect").pagination({pageCount:pageCountMateriel,current:curPageMateriel,
				   callback:function(n){var t=n.getCurrent();var materielKeys=$("input[name=materielKeys]").val();$("#listMaterForm input[name='curPage']").val(t),//$("#listMaterForm").submit()
					$.ajax({
					url : "packlingService/selectMateriel.do",
					type : "POST",
					dataType : "json",
					data : {"materielKeys":materielKeys,"curPage":t},
					success : function(data) {
					var json = eval(data.listData); //数组 
					$("#materForm tr").empty("");
					var serNo=((t-1)*pageSizeMateriel)+1;
			             $.each(json, function (index, item) {  
			                 //循环获取数据      
			            	 var serNoright=(serNo+index);
		                   if(json[index].picture!='' && !json[index].drawings.length>0){
		                	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td class='showCommentStyle'>"+json[index].comment+"</td><td class='gallery'><img width='20px' height='20px' alt='图片' src='dist/img/pic.png'></td><td></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
		                   }
		                   else if(json[index].drawings.length>0 && json[index].picture==''){
		                	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td class='showCommentStyle'>"+json[index].comment+"</td><td></td><td class='viewDrawing'><img width='20px' height='20px' alt='图纸' src='dist/img/draws.png'></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
		                   }
		                   else if (json[index].picture!='' && json[index].drawings.length>0){
		                	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td class='showCommentStyle'>"+json[index].comment+"</td><td class='gallery'><img width='20px' height='20px' alt='图片' src='dist/img/pic.png'></td><td class='viewDrawing'><img width='20px' height='20px' alt='图纸' src='dist/img/draws.png'></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
		                   }else{
		                	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td class='showCommentStyle'>"+json[index].comment+"</td><td class='gallery'></td><td class='viewDrawing'></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
		                   }
			             });
						}
					})
				   }})}),
	
	require(["common/modal.min"]),require(["common/select.min"],function(e){e.selectAll("selectAll","for-all"),e.selectAll("selectAll2","for-all2")}),require(["common/alert.min"],
		function(e){$(".delete").on("click",function(){
			var packDetailId = $(this).attr("data-id");
			e.confirm("您确定要删除吗？", function() {
				$.ajax({
					url : "packlingService/deleteDetail.do",
					type : "POST",
					data : {
						"packDetailId" : packDetailId,"curPage":curPage
					},
					dataType:"json",
					success : function(data) {
						//alert("删除成功(＾－＾)V");
//						var json = eval(data); //数组  
//						$("#packDetailForm tr").empty("");
//						var serNo=(pDataStartIndex+1);
//				               $.each(json, function (index, item) {  
//				                   //循环获取数据      
//				                    //var serNo=(index+1);  
//				                     //$("#packDetailForm").append("<tr><td>"+serNo+"</td><td>"+json[index].materielNo.materielNo+"</td><td>"+json[index].materielNo.materielName+"</td><td>"+json[index].materielNo.modelSpecification+"</td><td class='edit' id='quantity' data-id='"+json[index].id+"'>"+json[index].quantity+"</td><td>"+json[index].comment+"</td><td class='gallery'><a href='dist/img/temp/test1.jpg'>图1.jpg</a><a href='dist/img/temp/test2.png'>图2.jpg</a></td><td><a href='#drawingModal' data-action='modal'>图1.pdf</a></td><td><a class='delete' data-id='"+json[index].id+"'><i class='iconfont icon-delete'></i></a></td></tr>");
//				                   	 $("#packDetailForm").append("<tr><td>"+(serNo+index)+"</td><td>"+json[index].materielNo.materielNo+"</td><td>"+json[index].materielNo.materielName+"</td><td>"+json[index].materielNo.modelSpecification+"</td><td class='edit' id='quantity' data-id='"+json[index].id+"'>"+json[index].quantity+"</td><td>"+json[index].comment+"</td><td class='gallery'><c:forEach items='"+json[index].materielNo.picture+"' var='pict' varStatus='index'><c:if test='${index.index==0 }'><a href='${picturePath}${pict}'><img width='20px' height='20px' alt='图片' src='dist/img/pic.png'></a></c:if><c:if test='${index.index!=0 }'><a style='display: none;' href='${picturePath}${pict}'>${pict}</a></c:if></c:forEach></td><td><c:if test='"+json[index].materielNo.drawings!=null && json[index].materielNo.drawings.size>0+"'><a href='#drawingModal' class='viewDrawing' data-id='"+json[index].materielNo.materielNo+"' data-action='modal'><img width='20px' height='20px' alt='图纸' src='dist/img/draws.png'></a></c:if></td><td><a class='delete' data-id='"+json[index].id+"'><i class='iconfont icon-delete'></i></a></td></tr>");
//				               });
				               location.reload();
					},
					error : function() {
						alert("删除失败o(╯□╰)o");
					}
				})
			})
		})})
		
		//设置物料搜索事件
		$(function(){
		    $("#search").on("click",function(){
		        var materielKeys=$("input[name=materielKeys]").val();
		  		$.ajax({
		  		url : "packlingService/selectMateriel.do",
		  		type : "POST",
		  		dataType : "json",
		  		data : {"materielKeys":materielKeys,"curPage":1},
		  		success : function(data) {
		  		var json = eval(data.listData); //数组 
		  		$("#materForm tr").empty("");
		               $.each(json, function (index, item) {  
		                   //循环获取数据      
		              	 //var serNoright=(serNo+index);
		            	   var serNoright=(index+1);  
		            	    if(json[index].picture!='' && !json[index].drawings.length>0){
			                	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td class='showCommentStyle'>"+json[index].comment+"</td><td class='gallery'><img width='20px' height='20px' alt='图片' src='dist/img/pic.png'></td><td></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
			                   }
			                   else if(json[index].drawings.length>0 && json[index].picture==''){
			                	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td class='showCommentStyle'>"+json[index].comment+"</td><td></td><td class='viewDrawing'><img width='20px' height='20px' alt='图纸' src='dist/img/draws.png'></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
			                   }
			                   else if (json[index].picture!='' && json[index].drawings.length>0){
			                	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td class='showCommentStyle'>"+json[index].comment+"</td><td class='gallery'><img width='20px' height='20px' alt='图片' src='dist/img/pic.png'></td><td class='viewDrawing'><img width='20px' height='20px' alt='图纸' src='dist/img/draws.png'></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
			                   }else{
			                	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td class='showCommentStyle'>"+json[index].comment+"</td><td class='gallery'></td><td class='viewDrawing'></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
			                   }
		                 });
		               //移除分页参数
		               $("#listMaterForm input[name='curPage']").val(1)
		               $("#paginationSelect").remove();
		               $("[name=pageCountMaterielSelect]").remove();
		    	       $("[name=pageSizeMaterielSelect]").remove();
		    	       $("[name=curPageMaterielSelect]").remove();
		    	       $("[name=recordCountMaterielSelect]").remove();
		    	       //$("#selectMaterList").after(" <div id='paginationSelect2' class='pagination'></div>");
		    	       $("#materForm").append('<input type="hidden" name="pageCountMaterielSelect" value="'+data.pDataMateriel.pageCount+'"/>');
		    	       $("#materForm").append('<input type="hidden" name="pageSizeMaterielSelect" value="'+data.pDataMateriel.pageSize+'"/>');
		    	       $("#materForm").append('<input type="hidden" name="curPageMaterielSelect"  value="'+data.pDataMateriel.curPage+'"/>');
		    	       $("#materForm").append('<input type="hidden" name="recordCountMaterielSelect" value="'+data.pDataMateriel.recordCount+'"/>');
		    	  		//初始化分页控件栏
		    	       var pageCountMaterielSelect=$("[name=pageCountMaterielSelect]").val();
				  		var curPageMaterieSelectl=$("[name=curPageMaterielSelect]").val();
//			               require(["common/pagination.min"],
//		 			   function(){$("#paginationSelect2").pagination(
//		 					   {pageCount:pageCountMaterielSelect,current:curPageMaterieSelectl,
//		 				   callback:function(n){
//		 					   var t=n.getCurrent();var materielKeys=$("input[name=materielKeys]").val();$("#listMaterForm input[name='curPage']").val(t),//$("#listMaterForm").submit()
//		 					$.ajax({
//		 					url : "packlingService/selectMateriel.do",
//		 					type : "POST",
//		 					dataType : "json",
//		 					data : {"materielKeys":materielKeys,"curPage":t},
//		 					success : function(data) {
//		 					var json = eval(data.listData); //数组 
//		 					$("#materForm tr").empty("");
//		 					var serNo=((t-1)*10)+1;//(pDataStartIndex+1);
//		 			             $.each(json, function (index, item) {  
//		 			                 //循环获取数据      
//		 			            	 var serNoright=(serNo+index);
//		 			                if(json[index].picture!='' && !json[index].drawings.length>0){
//		 		                	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td>"+json[index].comment+"</td><td class='gallery'><img width='20px' height='20px' alt='图片' src='dist/img/pic.png'></td><td></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
//		 		                   }
//		 		                   else if(json[index].drawings.length>0 && json[index].picture==''){
//		 		                	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td>"+json[index].comment+"</td><td></td><td class='viewDrawing'><img width='20px' height='20px' alt='图纸' src='dist/img/draws.png'></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
//		 		                   }
//		 		                   else if (json[index].picture!='' && json[index].drawings.length>0){
//		 		                	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td>"+json[index].comment+"</td><td class='gallery'><img width='20px' height='20px' alt='图片' src='dist/img/pic.png'></td><td class='viewDrawing'><img width='20px' height='20px' alt='图纸' src='dist/img/draws.png'></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
//		 		                   }else{
//		 		                	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td>"+json[index].comment+"</td><td class='gallery'></td><td class='viewDrawing'></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
//		 		                   }
//		 			             });
//		 						}
//		 					})
//		 				   }})})
		  			}
		  		});
		  		//分页切换功能
		  		var pageCountMaterielSelect=$("[name=pageCountMaterielSelect]").val();
		  		var curPageMaterieSelectl=$("[name=curPageMaterielSelect]").val();
	               require(["common/pagination.min"],
 			   function(){$("#paginationSelect2").pagination(
 					   {pageCount:pageCountMaterielSelect,current:curPageMaterieSelectl,
 				   callback:function(n){
 					   var t=n.getCurrent();var materielKeys=$("input[name=materielKeys]").val();$("#listMaterForm input[name='curPage']").val(t),//$("#listMaterForm").submit()
 					$.ajax({
 					url : "packlingService/selectMateriel.do",
 					type : "POST",
 					dataType : "json",
 					data : {"materielKeys":materielKeys,"curPage":t},
 					success : function(data) {
 					var json = eval(data.listData); //数组 
 					$("#materForm tr").empty("");
 					var serNo=((t-1)*10)+1;//(pDataStartIndex+1);
 			             $.each(json, function (index, item) {  
 			                 //循环获取数据      
 			            	 var serNoright=(serNo+index);
 			                 if(json[index].picture!='' && !json[index].drawings.length>0){
 			              	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td class='showCommentStyle'>"+json[index].comment+"</td><td class='gallery'><img width='20px' height='20px' alt='图片' src='dist/img/pic.png'></td><td></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
 			                 }else if(json[index].drawings.length>0 && json[index].picture==''){//只有图纸
 			              	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td class='showCommentStyle'>"+json[index].comment+"</td><td></td><td class='viewDrawing'><img width='20px' height='20px' alt='图纸' src='dist/img/draws.png'></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"'><label for='select"+serNoright+"' ></label> </div></td> </tr>");
 			                 }else if (json[index].picture!='' &&  json[index].drawings.length>0){//图片图纸都有
 			              	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td class='showCommentStyle'>"+json[index].comment+"</td><td class='gallery'><img width='20px' height='20px' alt='图片' src='dist/img/pic.png'></td><td class='viewDrawing'><img width='20px' height='20px' alt='图纸' src='dist/img/draws.png'></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;' ><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"' ><label for='select"+serNoright+"' ></label> </div></td> </tr>");
 			                 }else{//没有图片图纸
 			              	   $("#materForm").append("<tr><td>"+serNoright+"</td> <td>"+json[index].materielNo+"</td> <td>"+json[index].materielTypeId.materielTypeName+"</td> <td class='showMaterielStyle'>"+json[index].materielName+"</td><td class='showMaterielStyle'>"+json[index].modelSpecification+"</td><td class='showCommentStyle'>"+json[index].comment+"</td><td class='gallery'></td><td class='viewDrawing'></td><td style='width: 50px;'> <div class='checkbox' style='margin-right:-5px;'><input type='checkbox' value='"+json[index].materielNo+"' class='for-all"+serNoright+"' name='selectId' onchange='changeallsel(this)'  id='select"+serNoright+"' ><label for='select"+serNoright+"' ></label> </div></td> </tr>");
 			                 }
 			             });
 			            $("#floatButton").attr("style","margin-top: 10px;position:fixed; top: 85%;left: 0;width: 100%;z-index: 99;");
 						}
 					})
 				   }})})
		  		})
				//BOM单导入功能 start
		  		$("#btnSave").on("click",function(){
		  			var fileName=$("[name=fileName]").val();
		  			var myFile=$("[name=myFile]").val();
		  			//var reg=/^(\w|[.-]|[\u4e00-\u9fa5]|\s){1,255}$/;
		  			 var reg=/^[^*\/\\|:<>?\"]*$/;
		  			    if(fileName!='' && myFile !=''){
		  			    	if(!reg.test(fileName)){
		  					    $(".fileNameMessage").html("文件名称不能包含<br/>下列任何字符：\ /  \\ : * ? \" < > |");
		  					 }else{
		  			       var formData = new FormData($("#completeForm")[0]);  // 要求使用的html对象
		  			     $.ajax({  
		  			          async: false, 
		  			          url: 'packlingService/importPacking.do' ,  
		  			          type: 'POST',  
		  			          data: formData, 
		  			          cache: false,  
		  			          processData: false, 
		  			          contentType: false,  
		  			          dataType:"json",
		  			          success: function (returndata) { 
			  			          if(returndata.count>0){
			  			             alert("导入成功"+returndata.count+"条数据");
			  			              location.reload();
			  			          }else if(returndata.count==0){
			  			             alert("导入成功"+returndata.count+"条数据，请检查数据文件");
			  			          }else{
			  			              alert("导入失败，请检查数据文件");
			  			          }
		  			            
		  	                    
		  			          },  
		  			          error: function (returndata) {  
		  			              alert("操作失败");  
		  			          }  
		  			     }); 
		  					 }
		  			    }else{
		  			    //  alert("请选择装箱清单文件");
		  			    $(".fileNameMessage").html("请选择装箱清单文件");
		  			    }
		  			});
		  //BOM单导入功能 start
		});
});