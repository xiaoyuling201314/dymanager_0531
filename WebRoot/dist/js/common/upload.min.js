define(["jquery","webuploader"],function($,e){function t(e){return this.each(function(){var t=$(this),n=t.data("bn.uploader"),a=$.extend({},t.data(),"object"==typeof e&&e);n||t.data("bn.uploader",n=new i(this,a)),"string"==typeof e&&n[e]()})}var i=function(e,t){this.$element=$(e),this.options=$.extend({},t),this.$uploadBox=null,this.$actionBar=null,this.$btnPick=null,this.$btnUpload=null,this.$info=null,this.fileCount=0,this.fileSize=0,this.init()};i.prototype.init=function(){var t=this.options,i="#"+this.$element.attr("id");$.each(this._setOptions(i),function(e,i){t[e]=t[e]||i}),void 0!==t.multiple&&(t.pick.multiple=t.multiple,delete t.multiple),t.innerHTML&&(t.pick.innerHTML=t.innerHTML,delete t.innerHTML),t.thumbWidth&&(t.thumb.width=t.thumbWidth,delete t.thumbWidth),t.thumbHeight&&(t.thumb.height=t.thumbHeight,delete t.thumbHeight);var n=this._newUpload(t),a=$('<div class="upload-box"><ul class="file-list"></ul><div class="action-bar"><div class="info"></div><div class="btn-area"><a class="btn-add">继续添加</a><a class="btn btn-green btn-upload">开始上传</a></div></div></div>');return this.$element.after(a),this.$uploadBox=a,this.$actionBar=a.find(".action-bar"),this.$btnPick=this.$element.find(".webuploader-pick"),this.$btnUpload=a.find(".btn-upload"),this.$info=a.find(".info"),e.Uploader.support()?void this._bindEvents(n):void alert("上传组件不支持您的浏览器！")},i.prototype._newUpload=function(t){return new e.Uploader(t)},i.prototype._createBox=function(e,t){var i=(this.$element,this),n=this.$uploadBox,a=this.options,o=$('<li id="'+e.id+'"><div class="preview"></div><div class="progress linear linear-primary"><div class="determinate"></div></div><div class="badge badge-radius"></div><ul class="file-panel"><li><a class="cancel" title="删除"><i class="iconfont icon-delete"></i></a></li></ul><div class="title" title="'+e.name+'">'+e.name+"</div></li>").appendTo(n.find(".file-list"));if(o.css("width",this.options.thumb.width),t.makeThumb(e,function(e,t){return e?void o.find(".preview").text("不能生成预览"):void o.find(".preview").append('<img src="'+t+'" >').css({height:a.thumb.height,width:a.thumb.width})}),n.find("li").length>0&&(i.$btnPick.hide(),i.$actionBar.show(),n.find(".webuploader-pick").length<=0)){var s=n.find(".btn-add");1===a.fileNumLimit?s.remove():t.addButton({id:n.find(".btn-add")})}o.on("click",".file-panel .cancel",function(){i._removeFile($(this).parents("li"),e,t)}),this.$btnUpload.on("click",function(){t.upload()})},i.prototype._bindEvents=function(e){var t=this;e.on("fileQueued",function(i){t.fileCount++,t.fileSize+=i.size,t._createBox(i,e),t._updateInfo("ready",e),t._updateState("ready",i)}),e.on("fileDequeued",function(i){t.fileCount--,t.fileSize-=i.size,t._updateInfo("ready",e)}),e.on("uploadProgress",function(e,t){$("#"+e.id).find(".progress").children(".determinate").css("width",Math.round(100*t)+"%")}),e.on("uploadAccept",function(e,i){t.$element.trigger("accept.upload",i)}),e.on("error",function(e){var t="";switch(e){case"F_DUPLICATE":t="该文件已经被选择了!";break;case"Q_EXCEED_NUM_LIMIT":t="上传文件数量超过限制!";break;case"F_EXCEED_SIZE":t="文件大小超过限制!";break;case"Q_EXCEED_SIZE_LIMIT":t="所有文件总大小超过限制!";break;case"Q_TYPE_DENIED":t="文件类型不正确或者是空文件!";break;case"F_CANNOT_REPEAT":t="文件不能重复!";break;default:t="未知错误!"}alert(t)}),e.on("uploadFinished",function(){t._updateInfo("finished",e)}),e.on("startUpload",function(){t._updateInfo("uploading",e)}),e.on("stopUpload",function(){t._updateInfo("paused",e)}),e.on("uploadComplete",function(e){t._updateState("complete",e)}),e.on("uploadStart",function(e){t._updateState("start",e)}),e.on("uploadError",function(e){t._updateState("error",e)}),e.on("uploadSuccess",function(e){t._updateState("success",e)})},i.prototype._removeFile=function(e,t,i){var n=(this.$element,this);i.removeFile(t),e.siblings("li").length<=0&&(n.$actionBar.hide(),n.$btnPick.show()),e.remove()},i.prototype._updateInfo=function(t,i){var n=this.$info,a=this;switch(t){case"ready":n.html('选中<b class="text-primary">'+a.fileCount+'</b>张图片，共<b class="text-primary">'+e.formatSize(a.fileSize)+"</b>。");break;case"finished":var o=i.getStats();n.html('已成功上传<b class="text-primary">'+o.successNum+'</b>张图片。<b class="text-red">'+o.uploadFailNum+'</b>张照片上传失败，<a class="retry">重新上传</a>失败图片'),a.$btnUpload.text("开始上传").removeClass("btn-outline btn-primary").addClass("btn-green"),a.$btnUpload.siblings(".btn-add").removeAttr("style");break;case"uploading":a.$btnUpload.text("暂停上传").removeClass("btn-green").addClass("btn-outline btn-primary"),a.$btnUpload.siblings(".btn-add").css("visibility","hidden");break;case"paused":a.$btnUpload.text("继续上传")}this.$btnUpload.on("click",function(){"paused"===t?i.upload():"uploading"===t&&i.stop()}),this.$info.on("click",".retry",function(){var e=i.getStats();e.uploadFailNum>0&&i.retry()})},i.prototype._updateState=function(e,t){var i=$("#"+t.id),n=i.find(".progress"),a=i.find(".badge");switch(e){case"success":a.text("上传成功").removeClass("badge-red").addClass("badge-green").show(),i.children(".file-panel").addClass("disabled");break;case"error":a.text("上传失败").addClass("badge-red").show();break;case"complete":n.hide();break;case"start":n.show();break;case"ready":n.hide(),a.hide()}},i.prototype._setOptions=function(e){return{pick:{id:e,innerHTML:"添加图片",multiple:!0},auto:!1,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png,svg",mimeTypes:"image/*"},thumb:{width:120,height:120,quality:70,allowMagnify:!1,crop:!0,type:""},fileVal:"file",dnd:"",paste:"",swf:"",sendAsBinary:!1,chunked:!0,chunkSize:524288,method:"POST",server:"",disableGlobalDnd:!0,fileNumLimit:300,fileSizeLimit:209715200,fileSingleSizeLimit:52428800}};var n=$.fn.uploader;$.fn.uploader=t,$.fn.uploader.Constructor=i,$.fn.uploader.noConflict=function(){return $.fn.uploader=n,this}});